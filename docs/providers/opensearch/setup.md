# OpenSearch

[OpenSearch](https://opensearch.org/) is a scalable, flexible, and extensible open-source software suite for search, analytics, and observability applications licensed under Apache 2.0. Powered by Apache Lucene and driven by the OpenSearch Project community, OpenSearch offers a vendor-agnostic toolset you can use to build secure, high-performance, cost-efficient applications. With [OpenSearch-KNN Plugin](https://opensearch.org/docs/latest/search-plugins/knn/index/) opensearch can be used as a Vector database.

- The database **needs the K-NN Plugin **, which are included in the self-hosted docker compose above.
- Run the App with the OpenSearch full distribution docker image: `docker compose up -d` in [this dir](/examples/docker/opensearch/).
- The app automatically creates a OpenSearch index on the first run. Optionally, create a custom index with a specific name and set it as an environment variable (see below).
- To enable more hybrid searching capabilities, adjust the document schema [here](/datastore/providers/opensearch_datastore.py).

**Environment Variables:**

| Name                              | Required | Description                                                                                                                                                                                                                                                                  | Default         |
|-----------------------------------| -------- |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------|
| `DATASTORE`                       | Yes      | Datastore name, set to `opensearch`                                                                                                                                                                                                                                          |                 |
| `BEARER_TOKEN`                    | Yes      | Secret token                                                                                                                                                                                                                                                                 |                 |
| `OPENAI_API_KEY`                  | Yes      | OpenAI API key                                                                                                                                                                                                                                                               |                 |
| `OPENSEARCH_HOST`                 | Optional | OpenSearch host url                                                                                                                                                                                                                                                          | `localhost`     |
| `OPENSEARCH_PORT`                 | Optional | OpenSearch port                                                                                                                                                                                                                                                              | `9200`          |
| `OPENSEARCH_USERNAME`             | Optional | OpenSearch Username                                                                                                                                                                                                                                                          |                 |
| `OPENSEARCH_PASSWORD`             | Optional | OpenSearch Password                                                                                                                                                                                                                                                          |                 |
| `OPENSEARCH_AUTH_TYPE`            | Optional | Authentication type for OpenSearch Datastore. Valid Values(`no-auth`, `user-pass`, `awssig4`, `kerberos`) [More details](https://github.com/opensearch-project/opensearch-py/blob/main/USER_GUIDE.md#using-different-authentication-methods)                                 | `no-auth`       |
| `OPENSEARCH_INDEX_NAME`           | Optional | Name of the OpenSearch index to store the data                                                                                                                                                                                                                               | `open-ai-index` |
| `OPENSEARCH_KNN_FIELD_NAME`       | Optional | Field name where the k-NN vector will be stored                                                                                                                                                                                                                              | `embedding`     |
| `OPENSEARCH_INDEX_PRIMARIES`      | Optional | Number of primary shard for OpenSearch Index                                                                                                                                                                                                                                 | `1`             |
| `OPENSEARCH_INDEX_REPLICAS`       | Optional | Number of replica shard for OpenSearch Index                                                                                                                                                                                                                                 | `0`             |
| `OPENSEARCH_KNN_ENGINE`           | Optional | Opensearch [K-NN engine](https://opensearch.org/docs/latest/search-plugins/knn/knn-index/#method-definitions) to be used for index creation. (`nmslib`, `faiss`)                                                                                                             | `nmslib`        |
| `OPENSEARCH_KNN_VECTOR_DISTANCE`  | Optional | The vector space used to calculate the distance between vectors. [More details](https://opensearch.org/docs/latest/search-plugins/knn/knn-index)                                                                                                                             | `l2`            |
| `OPENSEARCH_EMBEDDING_IN_RESULT`  | Optional | This parameter controls whether you need embeddings in query response. If you make it False then embeddings are not returned in query response which will reduce the latecny of query. [Refernce](https://opensearch.org/docs/latest/search-plugins/knn/performance-tuning/) | `False`         |
| `OPENSEARCH_SEARCH_TYPE`          | Optional | Type of Search you want to do. With OpenSearch you can do vector search(k-NN search), keyword search(standard BM-25 search) or hybrid search(combining both keyword and K-NN search).                                                                                        | `vector_search` |
| `CA_CERTS_FULL_PATH`              | Optional | Path where CERTS for present of cluster for validation. [More Details](https://github.com/opensearch-project/opensearch-py/blob/main/USER_GUIDE.md#creating-a-client)                                                                                                        |                 |
| `AWS_REGION`                      | Optional | AWS region to connect to when using OpenSearch Managed by AWS. [More Details](https://github.com/opensearch-project/opensearch-py/blob/main/USER_GUIDE.md#using-iam-authentication-with-an-async-client)                                                                     | `us-west-2`     |
| `CLOUD_SEARCH_SERVICE`            | Optional | For AWS Managed OpenSearch cluster, using Amazon OpenSearch(`aoss`) or Amazon Elastic Search(`es`)  [More Details](https://github.com/opensearch-project/opensearch-py/blob/main/USER_GUIDE.md#using-iam-authentication-with-an-async-client)                                | `aoss`          |


### OpenSearch Search Type
1. Vector Search : This is k-NN search happening in OpenSearch which is performed via OpenSearch [K-NN plugin]((https://opensearch.org/docs/search-plugins/knn/index/))
2. Keyword Search : This is standard search which gets performed on the query string provided. Currently, during this search type in chatgpt-retrieval-plugin we are still going to vectorization the string because there is no option to remove it. Hence, the call to ML model still be performed.
3. Hybrid Search : This is combination of vector search and keyword search. If document is retrieved in either keyword search or k-NN search will be returned back. In case document ids are present in both then scores will be combined. This has the potential to favor one result over another as vector search scores and BM-25 scores can be at different scales. Refer [this](https://github.com/opensearch-project/neural-search/issues/126) issue on how this problem can be fixed.

### Reference Links
* [OpenSearch Website](https://opensearch.org/)
* [Downloads](https://opensearch.org/downloads.html).
* [Documentation](https://opensearch.org/docs/)
* [K-NN Documentation](https://opensearch.org/docs/search-plugins/knn/index/)
* [OpenSearch Cluster setup with Docker](https://opensearch.org/docs/latest/install-and-configure/install-opensearch/docker/#deploy-an-opensearch-cluster-using-docker-compose)
* [K-NN Performance Tunning](https://opensearch.org/docs/latest/search-plugins/knn/performance-tuning/)
